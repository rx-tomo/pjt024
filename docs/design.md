# ブラウザ単体Webアプリ（仕事のストレス判定図：デモ分析）設計案

## 参照（要点のみ利用）

- 東京大学 医学部精神医学教室「仕事のストレス判定図」
  - 入口（フレーム）：https://mental.m.u-tokyo.ac.jp/old/hanteizu/index.htm
  - テクニカルノート（健康リスク算出の根拠・係数）：https://mental.m.u-tokyo.ac.jp/old/hanteizu/Technote.htm
  - 質問票（簡易版12項目・採点法）：https://mental.m.u-tokyo.ac.jp/old/hanteizu/Qsheets.htm
  - 判定結果の読み方（総合健康リスク＝×÷100）：https://mental.m.u-tokyo.ac.jp/old/hanteizu/read.htm

---

## 目的（このアプリでやりたいこと）

ブラウザだけで動く静的Webアプリ（HTML+CSS+JS）として、以下を「デモ用ダミーデータ」で体験できるようにする。

1. **分析種類を選ぶ**
2. **データを選ぶ（生成/読み込み）**
3. **分析結果を見る（可視化 + 数値）**
4. **切り口・見た目を変えて深掘り（フィルタ/グループ/シミュレーション）**

「仕事のストレス判定図」で扱う4要因（量的負担/コントロール/上司支援/同僚支援）と健康リスク計算を中心に、集団分析の“手触り”を再現する。

---

## 要件（機能）

### コア（MVP）

- データ
  - デモ用ダミーデータ生成（従業員 n=50〜500、部署/職種/拠点/シフト等の属性つき）
  - CSV/JSON読み込み（ローカルファイルをブラウザで読み込む。サーバ送信なし）
  - 生成・読み込みしたデータをブラウザ内に保持（リロードで消える想定。必要ならエクスポートで保存）
- スコア計算（簡易版12項目）
  - 回答（1〜4）から4尺度を算出（量的負担/コントロール/上司支援/同僚支援）
  - 個人→集団（部署等）の平均値へ集計
- 2つの判定図 + 総合健康リスク
  - 図1：量的負担（X）×コントロール（Y）
  - 図2：上司支援（X）×同僚支援（Y）
  - 各図の健康リスク：`100 * exp((x-A)*α + (y-B)*β)`（図2は係数C,D,γ,δ）
  - 総合健康リスク：`risk1 * risk2 / 100`（read.htmの説明に準拠）
- 深掘り
  - グループ切り替え（部署/職種/拠点/シフト/性別などで集計単位を変更）
  - フィルタ（例：拠点=東京、職種=製造、など）
  - 施策シミュレーション（例：量的負担を -0.3点、上司支援を +0.4点…）→ リスクがどう変わるか

### 追加（Nice to have）

- 分布（個人スコアのヒストグラム）・ばらつき（箱ひげ）・相関（散布図）
- 複数集団を同一判定図に重ね描き（凡例/ホバー/選択で強調）
- 係数セットの切替（従来男女別 / 将来の男女共通係数など）
- レポート出力（PNG/SVGエクスポート、集計表CSV）
- アクセシビリティ（キーボード操作、色弱対応パレット、説明テキスト）

---

## 非機能要件（制約）

- ブラウザ単体（サーバ不要）。`index.html` を開けば動く。
- 外部通信なし（CDN依存なし）。ライブラリ無しのVanilla JS（ES Modules）を前提。
- 個人情報は扱わない前提（デモデータのみ）。ただし読み込み機能はローカル処理のみで完結。

---

## 仕様（画面・操作フロー）

### 画面構成（1ページSPA）

- 左：ステップナビ（1〜3）
- 右：メイン領域（ステップの内容）
- 右上：データ概要（件数/選択中フィルタ/グループ数）

### Step 1: データを選ぶ（最初）

- デモデータ選択（最初にここで選ぶ）
  - パターン例：標準的企業 / 高ストレス多め / 年齢層高め / 職種混合 / （比較しやすい追加パターン）
  - 目的：まず「分析対象」が何かを決めてから分析へ進む
- デモ生成（任意）
  - 人数、部署数、拠点数、性別比、ばらつき（標準偏差）などのパラメータ
  - 「生成」ボタンで `dataset` を作成（データベース導入前の代替）
- ファイル読み込み
  - CSV（列：`id, group, sex, q1..q12, ...`）
  - JSON（後述のスキーマ）
  - バリデーション結果（欠損/範囲外/列不足）を表示

### Step 2: 分析を選ぶ

- 「仕事のストレス判定図（2図＋総合）」をデフォルト
- 追加の分析（分布、ランキング、相関、シミュレーション）をタブで選択

### Step 3: 結果を見る（分析画面）

- 説明（アコーディオン）
  - 分析の目的/計算/結果の読み方/参考リンクを、初心者向けに確認できる
- KPIカード
  - 選択集団の平均（4尺度）
  - 図1健康リスク、図2健康リスク、総合健康リスク
- 判定図（2枚）
  - 等リスク線（60/80/100/120/140/160 など） + プロット点
  - ホバーで集団名と値
  - 複数集団表示の場合は色分け、選択で強調
- 集計表
  - 各集団の平均とリスク（ソート/検索）

※当初「深掘り」を別メニューにする案もあったが、実装ではユーザ混乱を避けるため **Step 3（分析結果）に統合**し、同一画面内で切り口変更・フィルタ・表示・シミュレーションを行う。

---

## 追加提案（記録）

### 男女別表示時のランキング表の見せ方（UI案）

現状の実装では、男女別モードにおいてランキング表は「部署/男性」「部署/女性」のようにキーを分離した上で、総合健康リスク順に1つの表へ並べています（比較しやすい一方、性別ごとの一覧性はやや落ちます）。

将来の改善案として、以下の2方式を切り替え可能にすることを提案します。

1. **統合ランキング（現状）**：男女の行を混在させ、総合健康リスクの高い順に並べる
2. **男女別ランキング（追加案）**：表を「男性」「女性」でセクション分割し、各セクション内で順位付けする（同一性別内の把握が容易）

どちらをデフォルトにするかは、利用者の目的（「高リスク集団の発見」重視か、「性別内の傾向把握」重視か）で決めるのが良い。

### ローカル起動と GitHub Pages の両立（運用案）

- GitHub Pages は `docs/` 配下を公開するため、アプリ本体は `docs/stress-hantei/` に配置する。
- ローカルでの起動導線として、ルートに `index.html`（`docs/stress-hantei/` へのリダイレクト）と `local-start.command`（直接アプリを開く）を用意する。
- 目的：`file://` 制約（ES Modules 等）を避けつつ、ローカル/Pages の両方で迷わず起動できるようにする。

### 分析画面内の「データ切替」（動作確認用）

- Step 3 の画面上部に「データセット切替」UI（ドロップダウン/ボタン）を配置し、その場でデモデータを切り替え可能にする。
- 目的：データを変えると、判定図/集計表/ランキングなどの表示が即時に切り替わることを視覚的に確認する。
- 本番では不要になる想定のため、後で容易に無効化できる実装（フラグやビルド切替）にする。

### ヘルプページ（1ページ）

- 基本的な使い方（最短の手順）
- 用語集（全国平均 legacy/updated、健康リスク、総合健康リスク、4尺度、フィルタ/集計など）
- 出典・参考リンク
- 左メニュー最下部から小さくリンク

---

## 設計（データ・ロジック・UI）

### データモデル

#### 入力（個人回答）

```ts
type Sex = "male" | "female" | "unknown";

type EmployeeResponse = {
  id: string;
  attrs: {
    group?: string;      // 部署など（任意）
    role?: string;       // 職種
    site?: string;       // 拠点
    shift?: string;      // シフト
    sex?: Sex;
    ageBand?: string;    // 例: "20s" "30s"（任意）
  };
  answers: {
    // 簡易版12項目（1〜4）
    q1: number; q2: number; q3: number;
    q4: number; q5: number; q6: number;
    q7: number; q8: number; q9: number;
    q10: number; q11: number; q12: number;
  };
};
```

#### 派生（個人スコア）

```ts
type PersonScores = {
  workload: number;        // 量的負担（q1+q2+q3）: 3..12
  control: number;         // コントロール（q4+q5+q6）: 3..12
  supervisorSupport: number; // 上司支援（q7+q9+q11）: 3..12
  coworkerSupport: number;   // 同僚支援（q8+q10+q12）: 3..12
};
```

#### 集団集計（表示の中心）

```ts
type GroupAggregate = {
  key: string;        // groupByで決まるキー
  n: number;
  mean: PersonScores;
  risk: {
    demandControl: number;      // 図1
    support: number;            // 図2
    total: number;              // 図1*図2/100
  };
};
```

### スコア計算（簡易版12項目）

- Qsheets.htmの定義に合わせて合計点で尺度を作る
  - 量的負担 = q1 + q2 + q3
  - コントロール = q4 + q5 + q6
  - 上司支援 = q7 + q9 + q11
  - 同僚支援 = q8 + q10 + q12

※ 本アプリでは「回答（1〜4）」が入力済みである前提。紙質問票の「そうだ=4…」等のマッピングは、デモ生成/CSV作成段階で済ませる。

### 係数セット（まずは従来・簡易版）

Technote.htm の係数表から、簡易版（職業性ストレス簡易調査票の必要部分を抜粋した12項目）向けの係数を内蔵する。

```ts
type Coeff = {
  A: number; alpha: number;
  B: number; beta: number;
  C: number; gamma: number;
  D: number; delta: number;
};
```

#### 簡易版（男女別）: 係数（Technote.htmより）

注：表中に2つ並ぶ全国平均は、掲載元注記にある「その後の調査データの蓄積に基づく訂正値」を併記している可能性があるため、アプリでは `meansVersion`（`legacy`/`updated`）として切替可能にする。

- 男性（alpha/beta/gamma/delta は単一）
  - A=8.7, alpha=0.076
  - B=8.0（legacy） / 7.9（updated）, beta=-0.089
  - C=7.6（legacy） / 7.5（updated）, gamma=-0.097
  - D=8.1, delta=-0.097
- 女性
  - A=7.6（legacy） / 7.9（updated）, alpha=0.048
  - B=7.9（legacy） / 7.2（updated）, beta=-0.056
  - C=6.9（legacy） / 6.6（updated）, gamma=-0.097
  - D=8.1（legacy） / 8.2（updated）, delta=-0.097

※ 将来拡張：有識者ブログで触れられている「男女共通係数」等を追加の係数セットとして登録し、UIから切替。

### 健康リスク算出

- 図1（量的負担-コントロール）：
  - `risk1 = 100 * exp((x - A) * alpha + (y - B) * beta)`
- 図2（上司支援-同僚支援）：
  - `risk2 = 100 * exp((x - C) * gamma + (y - D) * delta)`
- 総合：
  - `total = risk1 * risk2 / 100`

### 判定図の描画（等リスク線が「直線」になる設計）

`risk = 100 * exp((x-A)*a + (y-B)*b)` は、`ln(r/100) = (x-A)*a + (y-B)*b`。
よって、ある `r` に対して

`y = B + ( ln(r/100) - (x-A)*a ) / b`

となり **等リスク線は直線**。

これにより、画像をトレースせずに「係数から動的に」判定図の斜線（60/80/100/120/140/160…）を描ける。

### UI実装方針（後続の実装フェーズで）

- 構成：Vanilla JS + ES Modules
- 状態管理：単純な `store`（immutable更新 + subscribe）で十分
- グラフ：SVG（軸/線/点/凡例/ツールチップを自前）
  - 軸スケール：簡易版は 3..12 を基本に、見やすさのため余白を足す
  - ラベル：キーボードでも対象点を選択可能にする（tab + aria）

### フォルダ構成案

```
/
  docs/
    index.html                  # GitHub Pages 用の入口
	    stress-hantei/              # アプリ本体（静的ホスト対象）
	      index.html
	      tests.html
	      help.html
	      assets/
	        style.css
      src/
        app.js
        store.js
        data/
          demoDatasets.js
          csvImport.js
          rng.js
        scoring/
          bjsq12.js
          risk.js
          coefficients.js
          analyze.js
        viz/
          stressChart.js
          rankingTable.js
          distributions.js
          simulator.js
          dom.js
    design.md
```

---

## テスト方針（次フェーズ）

- ロジック単体テスト（Node不要ならブラウザで動くミニテストランナーでも可）
  - スコア計算（12項目の合算が正しい）
  - リスク計算（基準点＝全国平均のとき risk=100 になる）
  - 総合リスク（例：110×120/100=132）
  - 等リスク線（任意点を線上に取ったとき計算値が狙いの r に近い）
- UIスモーク（最低限）
  - デモ生成→結果表示までノーエラー
  - CSV読み込みのバリデーションが想定通り
